<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Тренажер комбинаций — Punto Switcher</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../assets/common.css">
</head>

<body>
  <h1>Тренажёр Punto Switcher</h1>
  <div class="main">
    <div id="display-area"></div>
    <div id="prompt"></div>
    <div class="stats" id="stats">
      CPM: 0 | Точность: 100% | Ошибки: 0 | Комбинации: 0
    </div>
  </div>

  <footer>
    <div id="footer-count">Загружено комбинаций: 0</div>
    <div>created with ❤️ by <a href="https://t.me/q0wqex" target="_blank">q0wqex</a></div>
  </footer>

  <script>
    // Подгружаем словарь комбинаций из dict.txt
    let entries = [];

    fetch('dict.txt')
      .then(response => response.text())
      .then(text => {
        entries = text.trim().split('\n').map(line => {
          const [key, value] = line.split('=');
          return { key: key.trim(), value: value.trim() };
        });
        document.getElementById('footer-count').innerText = `Загружено комбинаций: ${entries.length}`;
        startTraining();
      })
      .catch(err => alert('Ошибка при загрузке dict.txt: ' + err));

    let currentIndex = 0;
    let currentTarget = '';
    let currentPos = 0;

    let totalChars = 0;
    let totalErrors = 0;
    let totalCombos = 0;
    let sessionStartTime = Date.now(); // старт всей сессии

    function startTraining() {
      nextCombination();
    }

    function nextCombination() {
      currentIndex = Math.floor(Math.random() * entries.length);
      currentTarget = entries[currentIndex].key;
      currentPos = 0;
      document.getElementById('display-area').innerText = entries[currentIndex].value;
      renderPrompt();
    }

    function renderPrompt() {
      let html = '';
      for (let i = 0; i < currentTarget.length; i++) {
        if (i < currentPos) html += `<span class="correct">${currentTarget[i]}</span>`;
        else html += `<span class="remaining">${currentTarget[i]}</span>`;
      }
      document.getElementById('prompt').innerHTML = html;
    }

    function updateStats() {
      const elapsedMinutes = (Date.now() - sessionStartTime) / 60000; // время с начала сессии
      const cpm = Math.round(totalChars / (elapsedMinutes || 1));
      const accuracy = totalChars + totalErrors > 0 ? Math.round((totalChars / (totalChars + totalErrors)) * 100) : 100;
      document.getElementById('stats').innerText =
        `CPM: ${cpm} | Точность: ${accuracy}% | Ошибки: ${totalErrors} | Комбинации: ${totalCombos}`;
    }

    // Обработка клавиш
    document.addEventListener('keydown', function (e) {
      let key = e.key;
      if (key.length === 1) {
        if (key === currentTarget[currentPos]) {
          currentPos++;
          totalChars++;
          renderPrompt();
          if (currentPos >= currentTarget.length) {
            totalCombos++;
            updateStats();
            setTimeout(nextCombination, 300);
          }
        } else {
          totalErrors++;
          let html = '';
          for (let i = 0; i < currentTarget.length; i++) {
            if (i < currentPos) html += `<span class="correct">${currentTarget[i]}</span>`;
            else if (i === currentPos) html += `<span class="incorrect">${currentTarget[i]}</span>`;
            else html += `<span class="remaining">${currentTarget[i]}</span>`;
          }
          document.getElementById('prompt').innerHTML = html;
          updateStats();
        }
      }
    });
  </script>

</body>

</html>
